<html>
    <head>
        <title>SoccerNoid</title>
        <script type="text/javascript" language="javascript" src="/SoccerNoid/sources/javascript/mainGame.js"></script>
        <link rel="stylesheet" type="text/css" href="/SoccerNoid/sources/css/main.css">

    </head>
    <body>
        <div class="gameHeader">

        </div>
        <div class="gameLeft">

        </div>
        <div id="cnt" class="gameGround">
            <img src="/SoccerNoid/sources/img/ball.png" style="display: none;" id = "ballImage" >

            <canvas id= "ourPlayground"  > </canvas>
           
            
        
        </div>
        <div class="gameScore" id="anzeigetafel">
            <div class="scoreHeader" id="scoreHead"></div>
            <div class="scoreMiddle" id="scoreMid"></div>
            <div class="scoreLivescores" id="scoreTab"></div>
        </div>
        <div class="gameFooter">
        
        </div>
        <script>
            var canvas = document.getElementById("ourPlayground");
var ctx = canvas.getContext("2d");
var container = document.getElementById("cnt");
canvas.width = container.offsetWidth;
canvas.height = container.offsetHeight;
var paddleHeight = 10;
var paddleWidth = 60;
var paddleX = 300;
var paddleY = canvas.height * 0.85;
var ballRadius = 10;
var ballX = canvas.width/2;
var ballY = canvas.height/2;
var score = 0;
var lives = 3;
var directionX = 1;
var directionY = 1;
var rightPressed = false;
var leftPressed = false;
var keyboardSpeed = 20;
var board = document.getElementById("anzeigetafel");
var user = JSON.parse(localStorage.getItem('userinitStorage')); 
var levelData;
var lvl = 1;
var visitor; 

loadLevel(lvl);

//board.innerHTML = "<p>"+user.name + " " + user.team+ "</p>";
document.addEventListener("mousemove", mouseMoveHandler, false);
document.addEventListener("keydown", keyDownHandler, false);

function loadLevel(levelCounter){
    initVisitor(levelCounter, user.team);
    setScoreBoard();
    var xmlhttp = new XMLHttpRequest();
    xmlhttp.onreadystatechange = function (){
        if(xmlhttp.readyState == 4){
        var levelJson = xmlhttp.responseText;
        initLevel(levelJson);
        draw();
        } 
    }
    xmlhttp.open("GET", "/SoccerNoid/sources/levels/level" + levelCounter + "/level.json", true);
    xmlhttp.send();
    
}
function initLevel(raw){
    var level = JSON.parse(raw);
    levelData = level;
}
function initVisitor(level, team){
    if(level == 1){
        switch(team){
            case "Germany":
                visitor = "Netherlands";
                break;
            case "Italy":
                visitor = "Germany";
                break;
            case "Turkey":
                visitor = "Germany";
                break;
            default: 
                visitor = "Germany";
        }
    }else{
        if(level == 2){
            switch(team){
            case "Germany":
                visitor = "France";
                break;
            case "Italy":
                visitor = "America";
                break;
            case "Turkey":
                visitor = "Belgium";
                break;
            default: 
                visitor = "France";
        }
        }else{
            switch(team){
            case "Germany":
                visitor = "Austria";
                break;
            case "Italy":
                visitor = "Netherlands";
                break;
            case "Turkey":
                visitor = "Italy";
                break;
            default: 
                visitor = "Austria";
        }
        }
    }
}
function setScoreBoard(){
    setScoreHeader();
    setScoreMiddle();
}
function setScoreHeader(){
    var head = document.getElementById("scoreHead");
    head.innerHTML =  "<img class='scoreImg' src='/SoccerNoid/sources/img/teams/"+user.team+".jpg'> VS <img class='scoreImg' src='/SoccerNoid/sources/img/teams/"+visitor+".jpg'>";
}
function setScoreMiddle(){
    var mid = document.getElementById("scoreMid");

    mid.innerHTML = "Lives: " + lives + " <br> Score: " + score;

    setScoreTable(user.name, user.team, score);
}
function setScoreTable(name, team, points){
    var tab = document.getElementById("scoreTab");
    var tmparr;
    var anzeige = 5;
    var inner = "<table class='tableLive'>";
    inner += "<tr class='tableTop'><th>Platzierung</th><th>Name</th><th>Team</th><th>Score</th></tr>"; 
    try {
        var scores = JSON.parse(localStorage.getItem("SoccerNoidHighscores"));
        tmparr = scores.users;
        tmparr.push([name, team, points]);
    } catch (error) {
        tmparr.push([name, team, pounts]);       
    }
    tmparr.sort(compareSecondColumn);
    if(tmparr.length < anzeige){
        anzeige = tmparr.length;
        document.getElementById("headerText").innerHTML = "Das sind die " + anzeige +" besten:";
    }
    for(i = 0 ; i < anzeige; i++){
        var platz = i+1;
        inner += "<tr class='tablePlace'><th>"+platz+"</th><th>"+scores.users[i][0]+"</th><th>"+scores.users[i][1]+"</th><th>"+scores.users[i][2]+"</th></tr>";  
    }
    inner += "</table>";
    tab.innerHTML = inner;
}
function keyDownHandler(e){
    if(e.keyCode == 39){
        rightPressed == true; 
        paddleX = paddleX + keyboardSpeed;
        if(paddleX + paddleWidth > canvas.width){
        paddleX = canvas.width -paddleWidth;
}
    }
    else if(e.keyCode == 37){
        leftPressed == true; 
        paddleX = paddleX - keyboardSpeed;
        if(paddleX < 0){
        paddleX = 0 ;
}
    
}
}


function mouseMoveHandler(e) {
var positionX = e.clientX - canvas.offsetLeft - paddleWidth/2;
if(positionX > 0 && positionX < canvas.width) {
        paddleX = positionX ; 
}
     if(positionX < 0){
        paddleX = 0 ;
}
    if(positionX + paddleWidth > canvas.width){
        paddleX = canvas.width -paddleWidth;
}
}

function drawScore() {
 ctx.font = "16px Arial";
 ctx.fillStyle = "darkgreen";
 ctx.fillText("Score: "+score, 20, 13);
}

function drawPaddle(){

   ctx.beginPath();
   ctx.rect(paddleX, paddleY, paddleWidth, paddleHeight);
   ctx.fillStyle = "black";
   ctx.fill();
   ctx.closePath();
  
}

function drawBall(){
   var image = document.getElementById("ballImage");
   ctx.drawImage(image, ballX,ballY, 2*ballRadius,2*ballRadius);
   moveBall();              
}
function drawBricks(){
    var rows, cols;
try {
       rows = levelData.positions.length;
       cols = levelData.positions[0].length;
       for(i = 0; i < rows; i++){
           for(j = 0; j < cols; j++){
                if(levelData.positions[i][j] > 0){
                    ctx.beginPath();
                    ctx.rect((canvas.width/cols * j)+(canvas.width*0.02),(canvas.height/2.5/rows*i) + (canvas.height * 0.05 ), canvas.width / (cols*1.2), canvas.height / 2.5 / (rows*1.5));
                    ctx.fillStyle = "black";
                    ctx.fill();
                    ctx.closePath()
                }   
           }
       }
} catch (error) {
    console.log("not loaded yet");
}

}

function draw() {
ctx.clearRect(0, 0, canvas.width, canvas.height);
drawBricks();
drawPaddle();
drawBall();
drawScore();


setTimeout(draw,30);
}

function moveBall(){
ballX += 5 * directionX;
ballY += 5 * directionY;
if(ballX + 2*ballRadius >= canvas.width || ballX  <= 0){
directionX *= -1;
}
if( ballY  <= 0 ){
directionY *= -1;
}
if(ballY + 2* ballRadius >= paddleY && ballY  <= paddleY + paddleHeight && ballX  >= paddleX  && ballX + 2*ballRadius <= paddleX + paddleWidth){
    directionY *= -1;
} 
else if(ballX + 2* ballRadius >= paddleX && ballX <= paddleX + paddleWidth && ballY  <= paddleY + paddleHeight && ballY + 2*ballRadius >= paddleY){
    directionX *= -1;
}
else if(ballY + 2*ballRadius >= canvas.height){
    lives --;
    setScoreMiddle();
    ballX = canvas.width/2;
    ballY = canvas.height/2;
    if(lives == 0){
        userexit(user.name, user.team, score);
        //window.location.href = "/SoccerNoid/sources/gameOver.html";
        
    }
}
}
function userexit(name, team, points){
    // muss nach verlorenem und gewonnenem spiel ausgef√ºhrt werden !
    setHighscores(name, team, points);
    var obj = {"name": name, "team": team, "score": points};
    localStorage.setItem("userexitStorage", JSON.stringify(obj));
}
function setHighscores(name, team, points){
    var scores;
    try {
        scores = JSON.parse(localStorage.getItem("SoccerNoidHighscores"));
        var tmp = scores.users[0][0];
    } catch (error) {
        var obj = {"users": [[name , team, points]]};
        localStorage.setItem("SoccerNoidHighscores", JSON.stringify(obj));
        console.log("First score saved");
        return;
    }
    scores.users.push([name, team, points]);

    scores.users.sort(compareSecondColumn);
    localStorage.setItem("SoccerNoidHighscores", JSON.stringify(scores));
}

function compareSecondColumn(a, b){
    if(a[2] === b[2]){
        if(a[0] === b[0]){
            if(a[1] === b[1]){
        return 0;
    }else{
        return (a[1] < b[1]) ? -1 : 1;
    }
    }else{
        return (a[0] < b[0]) ? -1 : 1;
    }
    }else{
        return (a[2] < b[2]) ? -1 : 1;
    }
}

        </script>
    </body>
</html>